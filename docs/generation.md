---
layout: default
---

<div style="text-align: right;">
[TOPページ](./index.html).
</div>
# パズルの生成

パズル生成の画面では、様々な条件が指定できますが、それらの条件が実際にパズルを生成する際にどういう意味合いを持つのかを説明します。


## 生成の仕組み

各種の条件の意味合いを理解するには、まず、パズル生成の仕組みを知る必要があります。  
パズルの生成は大きく、以下の2つの段階に分けることができます。

### 1）ループの生成

まず、最終的な正解となるできるだけ長い一続きのループを生成します。  
基本的には、ランダムに選択された点から、ランダムに線を伸ばしていき、できるだけ長い線が得られるよう試行錯誤します。  
もうそれ以上、線の先端を伸ばしていく余地がなくなり、まだ長さが足りない場合には、広い空き領域に接する部分の線を切断して、そこから空き領域へ向けて線を伸ばします。  
このようにして、盤面の大きさに対してある割合以上の長さのループを得ます。  
実際にはここで得られるループの形が問題の難易度に大きく影響しますが、あくまで偶然の結果であり、ここではどのレベルの問題でも同じ処理を行います。

### 2）数字の間引き

ループが決まったあと、盤面の全セルに数字を記入します。  
次に、生成パラメータの中の除去パターンによって定まるパターンに従って、盤面の数字を一定数ずつ順番に抜いてい（空白にして）行きます。  
1組数字を除去するたびに、その問題が論理的に解けるかどうかを確認して、制限時間内に解けた場合には抜いたセルはそのまま空白とし、解けなかった場合には元の数字に戻します。  
これを全セル分繰り返して、残ったものが生成された問題になります。  
生成パラメータの中の除去パターン以外のものは、問題が解けるかどうかを確認する際に使用する解法と、その制限時間になります。  
より高度な解法、長い制限時間を使用することで、数字が除去される率が上がり、結果的に難しい問題が生成されます。ただし、高度な解法＋長い制限時間の方が必ず難しくなるわけでもなく、場合によっては簡単な解法だけで非常に難しい問題ができてしまったりしますので、あくまでそういう傾向がある、とお考えください。


## 問題の解き方

数字を間引く際には、間引いた結果が問題として成立するのかどうかを、実際に解いてみることで判断します。
問題を解くのは、概ね以下のようなステップで行います。


### 1）初期配置

まず最初に数字の配置の状態から確定する辺の状態を確定します。本アプリでは、以下のようなパターンを利用しています。


### 2）解き進みループ

#### 基本解法

解法オプションを一つも指定しない場合、以下のようなロジックで確定できる辺を見つけます。

*    複数の数字のセルの並びから、あるいはコーナーに置かれた数字から、一部の辺の状態が確定
*   セルの数字といくつかの辺の状態から他の辺の状態を確定
*   1つの頂点に集まる複数の辺の中のいくつかの辺の状態から他の辺の状態を確定


#### 高度な解法

基本解法では確定する辺が1つも見つけられなかった場合に、生成オプションの指定次第で、以下のような高度な解法を利用して、確定点を探索します。  
それらの高度な解法で、辺（あるいは門、セルの色）の状態が確定すると、次からはまた基本解法での探索に戻ります。  

##### 斜めゲート[G]

一つのセルには、4隅に４つの頂点があります。その一つ一つの頂点を門に見立てて、ループが対象のセルの側からそのセルとは逆側に抜けていく場合にはその門が開いている、ループがその頂点で対象のセルの側からセルの外側には抜けない場合にはその門が閉じていると考えます。　　
このように考えたときに、セルの中の数字と辺の入り方で門の状態が確定したり、逆に門の状態が確定すると他の門のループの入り方が確定したりしますので、この性質を利用して問題を解いていきます。

##### セルの色[C]

スリザーリンクでは、問題が解けた際に一連のループが出来上がりますが、その内側のセルと外側のセルに異なる色がついていると考えた場合に、隣り合った２つのセルの色が同じ場合、その２つのセルの間にはループは通らず（辺がOFF）、異なる色だった場合にはループが通る（辺がON）という性質があります。  
この性質を利用して、問題を解き進めることができます。

##### １手仮置き[T]

まだ未確定な辺の1箇所を、仮にONにしてみます。その結果を元に問題を解いていき途中で矛盾が発生した場合（すでにOFFの辺をONにしようとする、等）その辺はOFFで確定します。  
矛盾が発生しないまま解くのに行き詰まった場合、またはそのまま解けてしまった場合には辺の状態が確定しないので、今度はOFFにしてみます。
その結果矛盾が発生した場合はONで確定しますが、発生なかった場合にはその辺では1手仮置きしても確定しないことになりますので、確定する辺が見つかるまで、別な未確定な辺で試してみます。  
すべての未確定の辺で試しても、確定する辺が見つからなければ、その問題は解けなかったことになります。


#### 判定

ループが完成し正解が得られるか、制限時間に到達するか、どの解法を用いてもそれ以上確定点が見つからなくなるまで、上で述べた手続きを繰り返します。  
正解が得られた場合は、除去した数字は空白のまま、次の除去に進みます。得られなかった場合には、除去した数字を元に戻します。



## 生成画面の指定内容

### 1）基本情報

#### 名称

名称は年（西暦2桁）月日＋連番3桁で自動的に振られますが、適宜指定することも可能です。

#### 幅、高さ

パズルの大きさを指定します。

### 2）プリセット

とりあえずプリセットで、レベルを指定すると、各レベルの推奨パターンがセットされます。
最初は、プリセットで生成してみて、もう少し易しくとかもう少し難しく、という場合に詳細設定を行うのがお薦めです。


### 3）詳細

#### 斜めゲート[G]

基本解法で打ち手が見つからなかった場合に、斜めゲート解法を利用するかどうかを指定します。

#### セルの色[C]

基本解法と斜めゲート解法で打ち手が見つからなかった場合に、セルの色解法を利用するかどうかを指定します。

#### １手仮置き[T]

基本解法と斜めゲート解法、セルの色解法で打ち手が見つからなかった場合に、１手仮置き解法を利用するかどうかを0-2のレベルで指定します。

*   0: １手仮置きを行いません。
*   1: １手仮置きを行う際に、仮置きをしたあと矛盾が発見されるまでに他の解法を利用してループを延長する最大長さを、盤面の総エッジ数の2%（21X14のパズルで12エッジ）に制限します。
*   2: 同じくループを延長する最大長さを、盤面の総エッジ数の20%（21X14のパズルで120エッジ）まで許容します。

#### 判定時間

パズルを各種の解法を駆使して解く際に、ある時間以上かかっても解けない場合には、その数字の並びでは解けないと判定します。
ここで指定する数字は、iPad Air 2（2015年製）で、処理した場合の最大処理時間（ミリ秒）になります。
例えば、ここで100と指定した場合、一組の数字を除去して、その問題が解けるか試みて、iPad Air 2 であれば100ミリ秒以内に正解が求められなければ、解けないと判断することになります。
処理時間は、使用するiPadの世代により大きく異なり、iPad Air 第3世代（2019年製）では、iPad Air 2 の概ね1/5程度のなりますので、ここで100と指定した場合の、問題を解く許容時間は20ms程度になります。
（使用しているiPadの処理性能は、アプリ起動時にサンプル問題を解いた時間から推定しています）

#### 除去パターン

盤面から数字を間引いていくパターンを選択します。
「XXX任意」という名称のパターンは、そのグループに属するいくつかの実際のパターンのどれかをランダムに選択すること意味します。
パターンは大きく分けると以下の4種類に分類できます。

*   4セル：一度に4つのセルの数字を同時に除去するパターンで、4つのセルの選択の仕方の異なるいくつかのパターンが存在します。
*   2セル：一度に2つのセルの数字を同時に除去するパターンで、2つのセルの選択の仕方の異なるいくつかのパターンが存在します。
*   1セル：一度に1つのセルの数字を除去するパターンです。早めに除去する部分の定義によりいくつかのパターンが存在します。
*   1セル（難問）：1セルと同じですが、早めに除去する部分の定義により、比較的難しい問題ができる傾向にあるパターンが選ばれています。




